<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Tech Sales Trail ‚Äî React (v3.2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* ====== Midnight Sales War Room Theme ====== */
    :root{
      --bg:#071225; --panel:#0a1730; --panel-2:#09142a; --text:#e9f2ff; --muted:#9fb6db;
      --accent:#1f7aff; --accent-2:#19a8ff; --good:#35d394; --warn:#ffd166; --bad:#ff6b6b;
      --chip:#0f1e3b; --btn:#0e2348; --btn-hover:#112e5e; --border:#16315a; --ink:#acc8ff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(31,122,255,0.35) 0, transparent 60%),
        radial-gradient(900px 700px at 110% 120%, rgba(25,168,255,0.22) 0, transparent 65%),
        linear-gradient(135deg,#030614 0,#050b1f 45%,#02030a 100%),
        repeating-linear-gradient(135deg, rgba(255,255,255,0.028) 0, rgba(255,255,255,0.028) 1px, transparent 1px, transparent 9px);
      background-attachment: fixed;
      color:var(--text);
    }
    .container{max-width:1200px;padding:20px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .title{display:flex;align-items:baseline;gap:10px}
    .title h1{margin:0;font-size:24px;letter-spacing:.3px}
    .chip{background:linear-gradient(180deg,var(--chip),#0c1833);border:1px solid var(--border);
      padding:8px 12px;border-radius:999px;color:var(--muted);font-size:12px;display:inline-flex;gap:8px;align-items:center}
    .grid{display:grid;gap:14px;grid-template-columns:1.25fr .9fr}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);
      border-radius:14px;padding:16px;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset,0 10px 30px rgba(0,0,0,.28)}
    h2{font-size:16px;margin:0 0 12px 0;font-weight:700;color:#dce9ff}
    .stats{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    @media (max-width:1200px){.stats{grid-template-columns:repeat(3,1fr)}}
    .stat{background:#0b1a39;border:1px solid var(--border);border-radius:10px;padding:10px;min-height:64px;display:flex;flex-direction:column;gap:6px}
    .stat .label{color:var(--muted);font-size:11px;letter-spacing:.3px}
    .stat .value{font-size:18px;font-weight:700}
    .bar{width:100%;height:8px;background:#0a1730;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar>div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .bar.good>div{background:linear-gradient(90deg,#4be38b,#38bfa0)}
    .bar.warn>div{background:linear-gradient(90deg,#ffd166,#ffb347)}
    .bar.bad>div{background:linear-gradient(90deg,#ff6b6b,#f94144)}
    .row{display:flex;align-items:center;gap:8px}
    .row.wrap{flex-wrap:wrap}
    .row.center{justify-content:center}
    .row.right{justify-content:flex-end}
    .row.between{justify-content:space-between}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;background:#0b1a39;border:1px solid var(--border);color:var(--muted)}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:800px){.actions{grid-template-columns:1fr}}
    .btn{
      border-radius:10px;border:1px solid var(--border);background:var(--btn);color:var(--text);
      padding:10px 12px;font-size:13px;text-align:left;cursor:pointer;display:block;width:100%;
      box-shadow:0 0 0 1px rgba(255,255,255,.02) inset,0 8px 24px rgba(0,0,0,.35);transition:background .12s,transform .08s,box-shadow .12s,border-color .12s
    }
    .btn .title{font-weight:600;font-size:13px;margin-bottom:3px}
    .btn .desc{font-size:12px;color:var(--muted)}
    .btn:hover:not(:disabled){background:var(--btn-hover);border-color:#2761c9;transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.5)}
    .btn:disabled{opacity:.45;cursor:not-allowed;box-shadow:none}
    .btn.primary{background:linear-gradient(180deg,#1c3a7a,#112e5e);border-color:#224a96}
    .btn.success{background:linear-gradient(180deg,#174b37,#0e3327);border-color:#1f5f47}
    .btn.ghost{background:transparent;border-color:var(--border)}
    .kbd{font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:6px;background:#0b1a39;color:var(--muted)}
    .sep{height:1px;background:var(--border);margin:10px 0}
    .badge-row{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:11px;padding:6px 8px;background:#0d1f44;border:1px solid var(--border);border-radius:8px;color:#c7dbff}
    .tiny{font-size:11px;color:var(--muted)} .spacer{height:6px} .mono{font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace}
    .log{height:320px;overflow:auto;background:#0b1a39;border:1px solid var(--border);
      border-radius:10px;padding:10px;font-size:13px}
    .log p{margin:0 0 8px 0}.log .muted{color:var(--muted)}
    .deal-list{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:1200px){.deal-list{grid-template-columns:1fr}}
    .deal{background:#0b1a39;border:1px solid var(--border);border-radius:10px;padding:10px;display:grid;grid-template-columns:1fr auto;gap:6px}
    .deal .name{font-weight:700}.deal small{color:var(--muted)}
    .pill{padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid var(--border);background:#091735}
    .pill.stage{color:#cde1ff}.pill.value{color:#9ff0c8}.pill.prob{color:#ffe0ae}
    .footer{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .cutbox{background:#061737;border:1px solid var(--border);border-radius:10px;padding:10px;white-space:pre;font-size:11px;line-height:1.3;color:var(--ink);
      font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace;overflow:auto;max-height:220px}
    dialog{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);margin:0;border:1px solid var(--border);border-radius:14px;padding:0;background:#070f26;color:var(--text);width:min(480px,94vw);box-shadow:0 18px 40px rgba(0,0,0,.7)}
    dialog::backdrop{background:rgba(2,5,15,.65);backdrop-filter:blur(4px)}
    dialog .d-header{padding:14px 16px;border-bottom:1px solid var(--border)}
    dialog .d-body{padding:16px}
    dialog .d-footer{padding:12px 16px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border)}
    .cutscene{margin:0}
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    const rand=(a,b)=>Math.random()*(b-a)+a;
    const randi=(a,b)=>Math.floor(rand(a,b+1));
    const choice=(arr)=>arr[Math.floor(Math.random()*arr.length)];
    const money=(n)=>"$"+Math.round(n).toLocaleString();
    const pct=(p)=>Math.round(p*100);
    const now=()=>new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const idGen=(()=>{let i=0; return ()=> (++i).toString(36)+"-"+Date.now().toString(36).slice(-4)})();

    const Stat=({label,value,sub,bar,kind})=>{
      let barClass=""; if(kind) barClass=kind;
      return (
        <div className="stat">
          <div className="label">{label}</div>
          <div className="value">{value}</div>
          {sub && <div className="tiny">{sub}</div>}
          {bar && <div className={"bar "+(barClass||"")}><div style={{width:bar.value+"%"}}/></div>}
        </div>
      );
    };

    const DealCard=({deal})=>(
      <div className="deal" style={{borderColor:"#16315a"}}>
        <div>
          <div className="name">{deal.account}</div>
          <small style={{color:"#a6bfeb"}}>Mood: {deal.mood} ‚Ä¢ Age: {deal.age}w</small>
        </div>
        <div className="row right">
          <span className="pill stage">{deal.stage}</span>
          <span className="pill value">{money(deal.value)}</span>
          <span className="pill prob">{deal.probNote||"‚Äì"}</span>
        </div>
      </div>
    );

    const Modal=({open,title,children,actions})=>{
      const ref=useRef();
      useEffect(()=>{
        if(!ref.current) return;
        if(open) ref.current.showModal();
        else if(ref.current.open) ref.current.close();
      },[open]);
      return (
        <dialog ref={ref} onCancel={(e)=>e.preventDefault()}>
          <div className="d-header"><strong>{title}</strong></div>
          <div className="d-body">{children}</div>
          <div className="d-footer">
            {actions?.map((a,i)=>(
              <button key={i} className={"btn "+(a.className||"ghost")} onClick={a.onClick} autoFocus={i===0}>
                {a.label}
              </button>
            ))}
          </div>
        </dialog>
      );
    };

    const Cutscene=({frames=[], speed=120, play=false})=>{
      const [i,setI]=useState(0);
      useEffect(()=>{
        if(!play||!frames.length){ setI(0); return; }
        setI(0);
        let idx=0;
        const id=setInterval(()=>{ idx=(idx+1)%frames.length; setI(idx); }, speed);
        return ()=> clearInterval(id);
      },[play,frames,speed]);
      return <div className="cutbox"><pre className="cutscene">{frames[i]||""}</pre></div>;
    };

    const newGame=()=>({
      week:1,maxWeeks:13,
      slots:5,maxSlots:5,restedThisWeek:false,
      energy:95,stress:28,
      skills:{prospect:45,discovery:35,demo:30,negotiate:25},
      reputation:40,manager:50,product:60,
      cash:1200,quota:120000,meetings:0,
      pipeline:0,closedWon:0,discounts:0,
      deals:[],logs:[],
      pip:false,fired:false,burnedOut:false,win:false,
      modifiers:{conversion:0,discount:0,expiresIn:0},
      achievements:[], runId:idGen(),
      used:{prospect:false,cadence:false,discovery:false,demo:false,propose:false,close:false,network:false,recharge:false}
    });

    const log=(s,msg,kind="info")=>{
      const entry={id:idGen(),t:now(),msg,kind};
      return {...s,logs:[entry,...s.logs].slice(0,120)};
    };

    const addAchievement=(s,key,label)=>{
      if(s.achievements.some(a=>a.key===key)) return s;
      return log({...s,achievements:[...s.achievements,{key,label}]},"üèÖ Achievement unlocked: "+label);
    };

    const STAGES=["Lead","Discovery","Demo","Proposal","Commit"];

    const makeDeal=(s,{warm=false,big=false}={})=>{
      const base=big? rand(22000,58000) : rand(5000,24000);
      const repMod=0.7+0.6*(s.reputation/100);
      return {
        id:idGen(),
        account: choice([
          "Acme","Globex","Initech","Umbrella","Stark",
          "Wayne","Tyrell","Hooli","Wonka","Cyberdyne"
        ])+" "+randi(1,999),
        value: Math.round(base*repMod),
        stage:0,
        mood: warm? choice(["curious","neutral"]):choice(["neutral","skeptical"]),
        probNote:"",
        age:0
      };
    };

    const tryCloseSome=(s,tag="üßæ Negotiations")=>{
      let ns={...s};
      const toTry=ns.deals.filter(d=>d.stage>=3);
      if(!toTry.length) return log(ns,`${tag}: nothing to close yet.`,"muted");
      let closed=0,sum=0,disc=0;
      ns.deals=ns.deals.map(d=>{
        if(d.stage<3) return d;
        let chance=clamp(
          0.10
          +0.33*(ns.skills.negotiate/100)
          +0.10*(ns.skills.discovery/100)
          +0.09*(ns.manager/100)
          +0.10*(ns.reputation/100)
          +0.10*(ns.product/100)
          -0.28*(ns.stress/100)
          +(ns.modifiers.conversion||0)
          +(d.stage>=4?0.05:0)
          +(d.mood==="happy"?0.08:0)
          -(d.mood==="skeptical"?0.06:0),
          0.04,0.88
        );
        const roll=Math.random();
        if(roll<chance){
          const rate=ns.modifiers.discount||0;
          const v=Math.round(d.value*(1-rate));
          sum+=v; disc+=Math.round(d.value*rate); closed++;
          return null;
        }else{
          const moodsOrder=["skeptical","neutral","curious","happy"];
          let i=moodsOrder.indexOf(d.mood);
          if(roll>0.9) i=Math.max(0,i-1);
          return {...d,mood:moodsOrder[i],probNote:`roll ${pct(roll)}% vs ${pct(chance)}%`};
        }
      }).filter(Boolean);
      ns.closedWon+=sum;
      ns.cash+=Math.round(sum*0.12);
      ns.discounts+=disc;
      ns = closed
        ? log(ns,`${tag}: closed ${closed} deal(s) for ${money(sum)}. Commission ${money(sum*0.12)}.`)
        : log(ns,`${tag}: everyone said ‚Äúcircle back later.‚Äù`,"warn");
      ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
      if(sum>=65000) ns=addAchievement(ns,"whale","üêã Whale Hunter");
      if(ns.closedWon>=ns.quota) ns=addAchievement(ns,"quota","üéâ Over Quota!");
      return ns;
    };

    const ageAndGhost=(s)=>{
      let ns={...s};
      ns.deals=ns.deals.filter(d=>{
        const tooOld=d.age>6 && d.stage<2 && Math.random()<0.20;
        const ghost=d.mood==="skeptical" && Math.random()<0.10;
        if(tooOld||ghost){ ns=log(ns,`üëª ${d.account} went dark.`,"warn"); return false; }
        return true;
      }).map(d=>({...d,age:d.age+1}));
      ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
      return ns;
    };

    const killDeals=(s,predicate,dropProb)=>{
      let ns={...s}, lost=0, lostVal=0;
      ns.deals = ns.deals.filter(d=>{
        if(predicate(d) && Math.random()<dropProb){ lost++; lostVal+=d.value; return false; }
        return true;
      });
      if(lost){ ns=log(ns,`üíÄ Lost ${lost} deal(s) totaling ${money(lostVal)}.`,"bad"); }
      ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
      return ns;
    };

    const cost=(s,{energy=0,slots=1,onceKey=null}={})=>{
      if(s.fired||s.burnedOut||s.win) return [s,false,"over"];
      if(s.slots<slots) return [s,false,"slots"];
      if(s.energy<energy) return [s,false,"energy"];
      if(onceKey && s[onceKey]) return [s,false,"once"];
      let ns={...s};
      ns.energy=clamp(ns.energy-energy,0,100);
      ns.slots-=slots;
      if(onceKey) ns[onceKey]=true;
      return [ns,true,null];
    };

    const randomEvents=(state,setPending,maxFires=2)=>{
      let ns={...state}, fired=0;
      const fire=(prob,fn)=>{ if(fired>=maxFires) return; if(Math.random()<prob){ ns=fn(ns); fired++; } };

      fire(0.22, st=>{
        const n=randi(2,6);
        const adds=Array.from({length:n},()=>makeDeal(st,{warm:true}));
        st.deals=[...adds,...st.deals];
        st.pipeline=st.deals.reduce((a,d)=>a+d.value,0);
        return log(st,`üì£ Marketing ‚ÄúSQL Storm‚Äù: ${n} warm leads landed.`);
      });

      fire(0.18, st=>{
        setPending({
          title:"üß® Competitor drops a 25% discount!",
          body:"Match the chaos or hold the line?",
          options:[
            {label:"Match (‚àí20% this week, +close rate)",className:"primary",
              action:(x)=>{
                x.modifiers={conversion:0.12,discount:0.20,expiresIn:1};
                return log(x,"üí∏ Matched. Finance is weeping. Close rate buffed for 1 week.");
              }},
            {label:"Hold the line (‚àíclose rate, +rep)",
              action:(x)=>{
                x.reputation=clamp(x.reputation+4,0,100);
                x.modifiers={conversion:-0.08,discount:0,expiresIn:1};
                return log(x,"Held the line. Some respect it, others ghost.");
              }}
          ]
        });
        return st;
      });

      fire(0.15, st=>{
        let hit=false;
        st.deals=st.deals.map(d=>{
          if(!hit && (d.stage===1 || d.stage===2)){
            hit=true;
            return {...d,stage:Math.max(0,d.stage-1),mood:"skeptical"};
          }
          return d;
        });
        if(hit){
          st.product=clamp(st.product-5,0,100);
          st.stress=clamp(st.stress+4,0,100);
          return log(st,"üõ†Ô∏è SE fat-fingered prod during demo. One deal regressed. Product ‚àí5.");
        }
        return st;
      });

      fire(0.10, st=>{
        st.product=clamp(st.product+10,0,100);
        st.deals=st.deals.map(d=> d.stage>=1? {...d,mood: d.mood==="skeptical"?"neutral":"happy"} : d);
        return log(st,"üßô SE MacGyver‚Äôd a live fix. Product +10. Prospects vibing.");
      });

      fire(0.09, st=>{
        setPending({
          title:"üîì Security Breach!",
          body:"Transparency buys trust but hurts win rate; spin stings rep but may keep pipe alive.",
          options:[
            {label:"Full transparency (trust +, pipe bleeds)",className:"primary",
              action:(x)=>{
                x.reputation=clamp(x.reputation+6,0,100);
                x.product=clamp(x.product-20,0,100);
                x.modifiers={conversion:-0.15,discount:0,expiresIn:2};
                x=killDeals(x,d=>d.stage>=2,0.30);
                return log(x,"üßØ Full transparency. Trust +, close rate ‚àí for 2w. Pipe took a beating.","warn");
              }},
            {label:"Spin Control (protect pipe, hurt rep)",
              action:(x)=>{
                x.reputation=clamp(x.reputation-8,0,100);
                x.product=clamp(x.product-15,0,100);
                x.modifiers={conversion:-0.10,discount:0,expiresIn:1};
                x=killDeals(x,d=>d.stage>=2,0.15);
                return log(x,"üåÄ Spun it. Rep ‚àí, smaller hit to close rate. Some deals still flaked.","warn");
              }}
          ]
        });
        return st;
      });

      fire(0.14, st=>{
        st.product=clamp(st.product-15,0,100);
        st.manager=clamp(st.manager-5,0,100);
        st=killDeals(st,d=>d.stage>=2,0.15);
        return log(st,"üå©Ô∏è Major cloud outage. Demos failed, a chunk of pipe fell off.","bad");
      });

      fire(0.14, st=>{
        st.modifiers={conversion:(st.modifiers.conversion||0)-0.06,discount:0,expiresIn:Math.max(1,st.modifiers.expiresIn)};
        return log(st,"üï≥Ô∏è Procurement Black Hole: ‚àí6% close rate this week.","warn");
      });

      fire(0.10, st=>{
        let moved=0;
        st.deals=st.deals.map(d=> d.stage===3 && Math.random()<0.5 ? (moved++, {...d,stage:2,mood:"neutral"}) : d);
        if(moved) st=log(st,`‚öñÔ∏è Legal Review Purgatory: ${moved} proposal(s) regressed.`,"warn");
        return st;
      });

      fire(0.12, st=>{
        const cand=st.deals.find(d=>d.stage>=2);
        if(cand){
          st.deals=st.deals.map(d=> d.id===cand.id ? {...d,stage:Math.min(4,d.stage+1),mood:"happy"} : d);
          st.reputation=clamp(st.reputation+3,0,100);
          st.manager=clamp(st.manager+4,0,100);
          return log(st,`ü™ú Champion promoted at ${cand.account}: momentum boost.`);
        }
        return st;
      });

      fire(0.11, st=>{
        st.reputation=clamp(st.reputation+5,0,100);
        st.modifiers={conversion:(st.modifiers.conversion||0)+0.08,discount:0,expiresIn:Math.max(1,st.modifiers.expiresIn)};
        return log(st,"üìò New customer case study trending. +Rep, +8% close for a week.");
      });

      fire(0.12, st=>{
        const n=randi(1,3);
        const adds=Array.from({length:n},()=>({...makeDeal(st,{warm:true,big:true}),mood:"happy"}));
        st.deals=[...adds,...st.deals];
        st.reputation=clamp(st.reputation+4,0,100);
        st.pipeline=st.deals.reduce((a,d)=>a+d.value,0);
        return log(st,`üê¶ Viral tweet hit. ${n} inbound whale(s) showed up.`);
      });

      fire(0.10, st=>{
        st.modifiers={conversion:(st.modifiers.conversion||0)-0.12,discount:0,expiresIn:Math.max(1,st.modifiers.expiresIn)};
        return log(st,"ü•∂ Budget freeze across your segment: ‚àí12% close rate.","warn");
      });

      fire(0.10, st=>{
        if(st.energy<50){
          st.stress=clamp(st.stress+6,0,100);
          st.energy=clamp(st.energy-10,0,100);
          return log(st,"ü§í Conference Crud: low energy made you sick. Stress +6, Energy ‚àí10.","warn");
        }
        return st;
      });

      return ns;
    };

    const CUTSCENES={
      club: [
`      .-========-.
      \`-:.  .:-'           PRESIDENT'S CLUB
  _.-=========-._           Jacket secured
 (.-:#########:-.)
  \\._\\#######/._/
    /\\#####/\\
   /__\\###/__\\     *  *     *   *      *
  '----\\#/----'      *   *    *    *      *`,
`      .-========-.
      \`-:.  .:-'           PRESIDENT'S CLUB
  _.-=========-._           Commission rains
 (.-:##*##*##:-.)
  \\._\\#######/._/      *      *
    /\\#####/\\        *   *      *    *
   /__\\###/__\\   *      *   *      *     *
  '----\\#/----'      *       *     *`,
`      .-========-.
      \`-:.  .:-'           PRESIDENT'S CLUB
  _.-=========-._           Pipeline obliterated
 (.-:#########:-.)
  \\._\\##***##/._/   *     *     *    *    *
    /\\#####/\\            *     *       *
   /__\\###/__\\     *    *    *    *       *
  '----\\#/----'   *        *       *`
      ],
      fired: [
`   _________
  /        /\\
 /  BOX   /  \\       YOU'RE DONE
/______/\\/____\\      Badge deactivated
\\      \\/      /
 \\____________/   HR reclaimed your dongles`,
`   _________
  /        /\\
 /  BOX   /  \\       THEY ESCORT YOU
/______/\\/____\\      Laptop in hand
\\      \\/      /     Slack already
 \\____________/      spinning the story`,
`   _________
  /        /\\
 /  BOX   /  \\       "WE'RE GOING IN
/______/\\/____\\       A DIFFERENT
\\      \\/      /      DIRECTION."
 \\____________/       (you are the direction)`
      ],
      burnout: [
`   (x_x)             BURNOUT
    /|\\        Neurons filed a ticket
    / \\        System on fire`,
`   (x_x)             BURNOUT
    /|\\        Commission good
    / \\        Cortisol better`,
`   (x_x)             BURNOUT
    /|\\        Inbox at 0
    / \\        Soul at 1`
      ],
      missed: [
`    .--.
 .-(    ).          BARELY MISSED
(___.__)__)         70‚Äì99% to quota
  ‚òî drizzle         Badge kept, ego bruised`,
`    .--.
 .-(    ).          BARELY MISSED
(___.__)__)         Manager sighs in relief
  ‚òî drizzle         HR goes back to sleep`,
`    .--.
 .-(    ).          BARELY MISSED
(___.__)__)         Close... so close
  ‚òî drizzle         next time: whale hunt`
      ]
    };

    function Game(){
      const [s,setS]=useState(()=> JSON.parse(localStorage.getItem("tst-save-v3-1")||"null") || newGame());
      const [pending,setPending]=useState(null);
      const [over,setOver]=useState(null);
      const [asciiSpeed,setAsciiSpeed]=useState(120);

      useEffect(()=>{
        localStorage.setItem("tst-autosave-v3-1", JSON.stringify(s));
      },[s]);

      useEffect(()=>{
        if(pending) return;
        if(s.fired||s.burnedOut||(s.week>s.maxWeeks)){
          const type = s.burnedOut ? "burnout"
                    : s.win ? "club"
                    : (s.week> s.maxWeeks && s.closedWon>=s.quota*0.7) ? "missed"
                    : "fired";
          const title = type==="club" ? "President‚Äôs Club ‚ú®"
                       : type==="burnout" ? "Burnout üßØ"
                       : type==="missed" ? "Barely Missed üòÆ‚Äçüí®"
                       : "Terminated üíº";
          const body = type==="club"
            ? `Closed ${money(s.closedWon)} vs quota ${money(s.quota)}.`
            : type==="burnout"
              ? `Closed ${money(s.closedWon)} but the soul said nope.`
              : type==="missed"
                ? `Closed ${money(s.closedWon)} against ${money(s.quota)}. Badge kept; grind continues.`
                : `Closed ${money(s.closedWon)}. HR reclaimed your dongles.`;
          setOver({title,body,type});
        } else {
          setOver(null);
        }
      },[s,pending]);

      const salaryAndBills=(state)=>{
        let ns={...state};
        ns.cash+=1000;
        if(ns.week===1 || ns.week===5 || ns.week===9){
          ns.cash-=1600;
          ns=log(ns,"üè† Rent hit: -$1,600.");
        }
        return log(ns,"üí∏ Salary processed: +$1,000.");
      };

      const countStage=(deals,stage)=>deals.filter(d=>d.stage===stage).length;

      const Actions=({s,setS})=>{
        const actProspect=()=>{
          let [ns,ok]=cost(s,{energy:25,slots:1}); if(!ok) return;
          const n=randi(1,4)+(Math.random()<(s.skills.prospect/100)*0.4?1:0);
          const adds=Array.from({length:n},()=>makeDeal(s,{warm:false}));
          ns.used.prospect=true;
          ns.meetings+=randi(0,n);
          ns.skills.prospect=clamp(ns.skills.prospect+1,0,100);
          ns.stress=clamp(ns.stress+2,0,100);
          ns.deals=[...adds,...ns.deals];
          ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          ns=log(ns,`üìû Prospect Blitz: -25 energy ‚Ä¢ +${adds.length} leads`);
          setS(ns);
        };

        const actCadence=()=>{
          let [ns,ok]=cost(s,{energy:18,slots:1}); if(!ok) return;
          const n=randi(0,3);
          const adds=Array.from({length:n},()=>makeDeal(s,{warm:true}));
          ns.used.cadence=true;
          ns.meetings+=randi(0,n);
          ns.deals=[...adds,...ns.deals];
          ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          ns=log(ns,`‚úâÔ∏è Email Cadence: -18 energy ‚Ä¢ ${n} warm replies`);
          setS(ns);
        };

        const actDiscovery=()=>{
          let [ns,ok]=cost(s,{energy:22,slots:1}); if(!ok) return;
          ns.used.discovery=true;
          let up=0;
          ns.deals=ns.deals.map(d=> d.stage===0 && Math.random()<(0.35+s.skills.discovery/200)?
            (up++,{...d,stage:1,mood:d.mood==="skeptical"?"neutral":d.mood}):d);
          ns.skills.discovery=clamp(ns.skills.discovery+2,0,100);
          ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          ns=log(ns,`üîé Discovery Deep Dive: -22 energy ‚Ä¢ qualified ${up}`);
          setS(ns);
        };

        const actDemo=()=>{
          let [ns,ok]=cost(s,{energy:28,slots:1}); if(!ok) return;
          ns.used.demo=true;
          let up=0;
          ns.deals=ns.deals.map(d=> d.stage===1 && Math.random()<(0.32+s.skills.demo/220+s.product/400)?
            (up++,{...d,stage:2,mood:d.mood==="neutral"?"curious":d.mood}):d);
          ns.skills.demo=clamp(ns.skills.demo+2,0,100);
          ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          ns=log(ns,`üñ•Ô∏è Demo Marathon: -28 energy ‚Ä¢ advanced ${up}`);
          setS(ns);
        };

        const actPropose=()=>{
          let [ns,ok]=cost(s,{energy:25,slots:1}); if(!ok) return;
          ns.used.propose=true;
          let up=0;
          ns.deals=ns.deals.map(d=> d.stage===2 && Math.random()<0.40?
            (up++,{...d,stage:3,mood:d.mood==="curious"?"happy":d.mood}):d);
          ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          ns=log(ns,`üìë Proposals & Commit: -25 energy ‚Ä¢ sent ${up} proposal(s)`);
          setS(ns);
        };

        const actClose=()=>{
          let [ns,ok]=cost(s,{energy:28,slots:1}); if(!ok) return;
          ns.used.close=true;
          ns.skills.negotiate=clamp(ns.skills.negotiate+1,0,100);
          ns=tryCloseSome(ns,"ü§ù Close Deals");
          setS(ns);
        };

        const actNetwork=()=>{
          let [ns,ok]=cost(s,{energy:16,slots:1}); if(!ok) return;
          const n=randi(1,2);
          const adds=Array.from({length:n},()=>({...makeDeal(s,{warm:true}),mood:"happy"}));
          ns.used.network=true;
          ns.reputation=clamp(ns.reputation+4,0,100);
          ns.deals=[...adds,...ns.deals];
          ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          ns=log(ns,`üßë‚Äçü§ù‚Äçüßë Referrals & Social: -16 energy ‚Ä¢ +${n} high-trust lead(s)`);
          setS(ns);
        };

        const actRecharge=()=>{
          let [ns,ok,err]=cost(s,{energy:0,slots:1,onceKey:"restedThisWeek"});
          if(!ok){
            if(err==="once") setS(log(s,"‚è±Ô∏è Recharge already used this week."));
            return;
          }
          ns.used.recharge=true;
          ns.energy=clamp(ns.energy+35,0,100);
          ns.stress=clamp(ns.stress-12,0,100);
          ns=log(ns,"üßò Recharge (once/week): +35 energy, -12 stress");
          setS(ns);
        };

        const actCoffee=()=>{
          let [ns,ok]=cost(s,{energy:0,slots:1}); if(!ok) return;
          ns.energy=clamp(ns.energy+18,0,100);
          ns.cash-=6;
          ns.stress=clamp(ns.stress+7,0,100);
          ns=log(ns,"‚òï Coffee Spike: +18 energy, -$6, +7 stress");
          setS(ns);
        };

        const actPolitics=()=>{
          let [ns,ok]=cost(s,{energy:10,slots:1}); if(!ok) return;
          ns.manager=clamp(ns.manager+4,0,100);
          ns.product=clamp(ns.product+3,0,100);
          ns.reputation=clamp(ns.reputation-1,0,100);
          ns=log(ns,"üó£Ô∏è Internal Politics: -10 energy ‚Ä¢ +Manager, +Product, -Rep");
          setS(ns);
        };

        const actConference=()=>{
          let [ns,ok]=cost(s,{energy:40,slots:2}); if(!ok) return;
          ns.cash-=800;
          const n=randi(3,8);
          const adds=Array.from({length:n},()=>makeDeal(s,{warm:true,big:Math.random()<0.4}));
          if(Math.random()<0.30){
            ns.modifiers={
              conversion:(ns.modifiers.conversion||0)+0.08,
              discount:ns.modifiers.discount||0,
              expiresIn:Math.max(1,ns.modifiers.expiresIn)
            };
          }
          ns.deals=[...adds,...ns.deals];
          ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          ns.stress=clamp(ns.stress+5,0,100);
          ns=log(ns,`üèüÔ∏è Conference Run: -40 energy, -$800 ‚Ä¢ +${n} leads (+chance of a hot whale)`);
          setS(ns);
        };

        const disabled=(needEnergy=0,needSlots=1)=> s.energy<needEnergy || s.slots<needSlots || s.fired || s.burnedOut || s.win;

        return (
          <div className="actions">
            <button className="btn" disabled={disabled(25,1)} onClick={actProspect}>
              <div className="title">üìû Prospect Blitz</div>
              <div className="desc">Find new leads. <strong>Cost:</strong> 25 Energy ‚Ä¢ 1 Slot</div>
            </button>
            <button className="btn" disabled={disabled(18,1)} onClick={actCadence}>
              <div className="title">‚úâÔ∏è Email Cadence</div>
              <div className="desc">Warm replies & meetings. <strong>Cost:</strong> 18 Energy ‚Ä¢ 1 Slot</div>
            </button>
            <button className="btn" disabled={disabled(22,1)} onClick={actDiscovery}>
              <div className="title">üîé Discovery Deep Dive</div>
              <div className="desc">Qualify top-of-funnel. <strong>Cost:</strong> 22 Energy ‚Ä¢ 1 Slot</div>
            </button>
            <button className="btn" disabled={disabled(28,1)} onClick={actDemo}>
              <div className="title">üñ•Ô∏è Demo Marathon</div>
              <div className="desc">Run demos. <strong>Cost:</strong> 28 Energy ‚Ä¢ 1 Slot</div>
            </button>
            <button className="btn" disabled={disabled(25,1)} onClick={actPropose}>
              <div className="title">üìë Proposals & Commit</div>
              <div className="desc">Advance to proposal. <strong>Cost:</strong> 25 Energy ‚Ä¢ 1 Slot</div>
            </button>
            <button className="btn" disabled={disabled(28,1)} onClick={actClose}>
              <div className="title">ü§ù Close Deals</div>
              <div className="desc">Push late-stage opps over the line. <strong>Cost:</strong> 28 Energy ‚Ä¢ 1 Slot</div>
            </button>
            <button className="btn" disabled={disabled(16,1)} onClick={actNetwork}>
              <div className="title">üßë‚Äçü§ù‚Äçüßë Referrals & Social</div>
              <div className="desc">High-trust intros. <strong>Cost:</strong> 16 Energy ‚Ä¢ 1 Slot</div>
            </button>
            <button className="btn" disabled={disabled(0,1)} onClick={actConference}>
              <div className="title">üèüÔ∏è Conference Run</div>
              <div className="desc">Chunky leads, macro buff chance. <strong>Cost:</strong> 40 Energy ‚Ä¢ 2 Slots ‚Ä¢ $800</div>
            </button>
            <button className="btn" disabled={disabled(0,1)} onClick={actRecharge}>
              <div className="title">üßò Recharge</div>
              <div className="desc">Once/week reset. <strong>Cost:</strong> 1 Slot</div>
            </button>
            <button className="btn" disabled={disabled(0,1)} onClick={actCoffee}>
              <div className="title">‚òï Coffee Spike</div>
              <div className="desc">Short-term energy, long-term stress. <strong>Cost:</strong> 1 Slot ‚Ä¢ $6</div>
            </button>
            <button className="btn" disabled={disabled(10,1)} onClick={actPolitics}>
              <div className="title">üèõÔ∏è Internal Politics</div>
              <div className="desc">Manager & product boost, rep hit. <strong>Cost:</strong> 10 Energy ‚Ä¢ 1 Slot</div>
            </button>
          </div>
        );
      };

      const endWeek=()=>{
        if(s.fired||s.burnedOut||s.win) return;
        let ns={...s};

        if(Math.random()<0.15) ns=tryCloseSome(ns,"üïò EOWeek Surprises");

        ns=salaryAndBills(ns);
        ns=randomEvents(ns,setPending,2);
        ns=ageAndGhost(ns);

        const u=ns.used;
        const didProspectish = u.prospect || u.cadence || u.network;
        const didLateStage = u.propose || u.close;
        const coreCombo = didProspectish && u.discovery && u.demo && didLateStage;

        let skipCount = 0;
        if(!didProspectish) skipCount++;
        if(!u.discovery) skipCount++;
        if(!u.demo) skipCount++;
        if(!u.propose) skipCount++;
        if(!u.close) skipCount++;

        if(coreCombo){
          ns.modifiers={conversion:(ns.modifiers.conversion||0)+0.10,discount:ns.modifiers.discount||0,expiresIn:Math.max(1,ns.modifiers.expiresIn)};
          ns=log(ns,"üß© Full-motion week (prospect ‚Üí discovery ‚Üí demo ‚Üí late-stage) ‚ûú +10% close next week.");
        }else if(skipCount>=2 && ns.pipeline>0){
          ns.modifiers={conversion:(ns.modifiers.conversion||0)-0.06,discount:ns.modifiers.discount||0,expiresIn:Math.max(1,ns.modifiers.expiresIn)};
          ns=log(ns,"ü™´ Motion skipped ‚ûú ‚àí6% close next week.","warn");
        }

        if(!u.discovery && countStage(ns.deals,0)>=6){
          let lost=0;
          ns.deals = ns.deals.filter(d=> (d.stage===0 && Math.random()<0.15)? (lost++, false) : true);
          if(lost){
            ns=log(ns,`ü•∂ Lead decay: ${lost} raw lead(s) went cold.`,"warn");
            ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          }
        }
        if(!u.demo && countStage(ns.deals,1)>=5){
          let reg=0;
          ns.deals = ns.deals.map(d=> (d.stage===1 && Math.random()<0.15)? (reg++, {...d,stage:0,mood:"skeptical"}) : d);
          if(reg){
            ns=log(ns,`üïë Demo backlog: ${reg} qualified lead(s) went stale.`,"warn");
            ns.pipeline=ns.deals.reduce((a,d)=>a+d.value,0);
          }
        }

        ns.energy=clamp(ns.energy+15,0,100);
        ns.stress=clamp(ns.stress-4,0,100);

        if(ns.modifiers.expiresIn>0){
          ns.modifiers.expiresIn-=1;
          if(ns.modifiers.expiresIn<=0) ns.modifiers={conversion:0,discount:0,expiresIn:0};
        }

        ns.week+=1;
        ns.slots=ns.maxSlots;
        ns.restedThisWeek=false;
        ns.used={prospect:false,cadence:false,discovery:false,demo:false,propose:false,close:false,network:false,recharge:false};

        if(ns.week>=7 && !ns.pip){
          const perf=ns.closedWon/ns.quota, coverage=ns.pipeline/ns.quota;
          if(perf<0.25 && coverage<1.3){ ns.pip=true; ns=log(ns,"üìÑ You‚Äôre on a PIP. Milestones or HR.","bad"); }
        }
        if(ns.pip && ns.week===10){
          const perf=ns.closedWon/ns.quota;
          if(perf<0.55){ ns.fired=true; ns=log(ns,"üìâ Missed PIP milestone. Box the laptop.","bad"); }
          else { ns.pip=false; ns=log(ns,"‚úÖ PIP passed. HR memory-holed it."); }
        }

        if(ns.stress>=100){
          ns.burnedOut=true;
          ns=log(ns,"üßØ Burnout: neurons filed a ticket.","bad");
        }
        if(ns.cash<-2000){
          ns.fired=true;
          ns=log(ns,"üèöÔ∏è Financial doom spiral.","bad");
        }
        if(ns.week>ns.maxWeeks){
          const hit=ns.closedWon>=ns.quota;
          ns.win=hit;
          if(hit) ns=log(ns,"üèÜ PRESIDENT'S CLUB: jacket secured.");
          else if(ns.closedWon>=ns.quota*0.7) ns=log(ns,"üòÆ‚Äçüí® Barely Missed: kept badge, dodged HR.");
          else{
            ns.fired=true;
            ns=log(ns,"üîö Under 70%: pipeline parted ways with you.","bad");
          }
        }

        const perfPct=Math.min(100,Math.round((ns.closedWon/ns.quota)*100));
        ns.manager=clamp(ns.manager+(perfPct-40)/50,0,100);

        setS(ns);
      };

      const handleNew=()=>{
        setS(newGame());
        setPending(null);
        setOver(null);
      };

      const handleSave=()=>{
        localStorage.setItem("tst-save-v3-1", JSON.stringify(s));
        alert("Saved!");
      };

      const handleLoad=()=>{
        const v=localStorage.getItem("tst-save-v3-1");
        if(v){
          setS(JSON.parse(v));
          setPending(null);
          setOver(null);
        }else{
          alert("No save yet.");
        }
      };

      return (
        <div className="container">
          <header>
            <div className="title">
              <h1>üß≠ Tech Sales Trail</h1>
              <span className="chip">Matt, 25 ‚Ä¢ SDR @ <strong>Shitcorp</strong></span>
            </div>
            <div className="row">
              <button className="btn ghost" onClick={handleNew}>New Game</button>
              <button className="btn ghost" onClick={handleSave}>Save</button>
              <button className="btn ghost" onClick={handleLoad}>Load</button>
            </div>
          </header>

          <div className="grid">
            <div className="panel">
              <div className="row" style={{justifyContent:"space-between", marginBottom:10}}>
                <h2>Quarter Map</h2>
                <div className="row">
                  <span className="kbd">Wk {s.week}/{s.maxWeeks}</span>
                  <span className="kbd">Slots {s.slots}/{s.maxSlots}</span>
                  <span className="kbd mono">Run {s.runId.slice(0,5)}</span>
                </div>
              </div>

              <div className="stats">
                <Stat label="Energy" value={`${s.energy}/100`} bar={{value:s.energy}} kind={s.energy>50?"good":s.energy>25?"warn":"bad"}/>
                <Stat label="Stress" value={`${s.stress}/100`} bar={{value:s.stress}} kind={s.stress<40?"good":s.stress<70?"warn":"bad"}/>
                <Stat label="Cash" value={money(s.cash)} sub="Salary + commission"/>
                <Stat label="Pipeline" value={money(s.pipeline)} sub={`${s.deals.length} live deals`}/>
                <Stat label="Closed" value={money(s.closedWon)} sub={`${pct(s.closedWon/s.quota)}% of quota`}/>
                <Stat label="Manager" value={s.manager} bar={{value:s.manager}}/>
                <Stat label="Prospecting" value={s.skills.prospect} bar={{value:s.skills.prospect}}/>
                <Stat label="Discovery" value={s.skills.discovery} bar={{value:s.skills.discovery}}/>
                <Stat label="Demo" value={s.skills.demo} bar={{value:s.skills.demo}}/>
                <Stat label="Negotiation" value={s.skills.negotiate} bar={{value:s.skills.negotiate}}/>
                <Stat label="Reputation" value={s.reputation} bar={{value:s.reputation}}/>
                <Stat label="Product" value={s.product} sub="Stability vibes" bar={{value:s.product}}/>
              </div>

              <div className="sep"></div>

              <Actions s={s} setS={setS}/>

              <div className="footer">
                <div className="badge-row" style={{marginRight:"auto"}}>
                  {s.pip && <span className="badge">üìÑ On PIP</span>}
                  {s.modifiers.discount>0 && <span className="badge">üßæ Discount Mode</span>}
                  {s.modifiers.conversion!==0 && <span className="badge">üé≤ Conversion Mod</span>}
                  {s.restedThisWeek && <span className="badge">üßò Rested</span>}
                  {s.achievements.map(a=><span key={a.key} className="badge">{a.label}</span>)}
                </div>
                <button className="btn ghost"
                  onClick={()=>{
                    const [ns,ok]=cost(s,{energy:0,slots:1});
                    if(!ok) return;
                    let st=tryCloseSome(ns,"üß™ Opportunistic Close");
                    setS(st);
                  }}
                  disabled={s.slots<=0 || s.fired || s.burnedOut || s.win}
                >Try Close Now (1 Slot)</button>
                <button className="btn primary" onClick={endWeek} disabled={s.fired||s.burnedOut||s.win}>
                  <strong>End Week</strong>
                </button>
              </div>
            </div>

            <div className="panel">
              <h2>Active Deals</h2>
              <div className="deal-list">
                {s.deals.length
                  ? s.deals.slice(0,10).map(d=><DealCard deal={{...d,stage:STAGES[d.stage]}} key={d.id}/>)
                  : <div className="tiny">No active deals yet. Phone go brr.</div>}
              </div>

              <div className="spacer"></div>
              <h2>Activity Log</h2>
              <div className="log">
                {s.logs.length
                  ? s.logs.map(l=> <p key={l.id}><span className="muted">{l.t}</span> ‚Äî {l.msg}</p>)
                  : <p className="muted">Logs appear here. Make some noise.</p>}
              </div>
            </div>
          </div>

          <Modal
            open={!!pending}
            title={pending?.title || "Event"}
            actions={pending? pending.options.map((o)=>({
              label:o.label,
              className:o.className,
              onClick:()=>{
                let st=o.action(s);
                setPending(null);
                setS(st);
              }
            })) : []}
          >
            <div><p style={{marginTop:0}}>{pending?.body}</p></div>
          </Modal>

          <Modal
            open={!!over}
            title={over?.title || "Game Over"}
            actions={[
              {label:"New Run",className:"success",onClick:()=>{ setS(newGame()); setOver(null); }},
              {label:"Close",className:"ghost",onClick:()=>{
                const x=document.querySelector("dialog[open]");
                if(x) x.close();
                setOver(null);
              }}
            ]}
          >
            <p style={{marginTop:0}}>{over?.body}</p>
            <Cutscene frames={CUTSCENES[over?.type||"club"]} speed={asciiSpeed} play={!!over}/>
            <div className="row" style={{justifyContent:"space-between"}}>
              <div className="badge-row">
                <span className="badge">Closed: {money(s.closedWon)}</span>
                <span className="badge">Pipeline: {money(s.pipeline)}</span>
                <span className="badge">Quota: {money(s.quota)} ({pct(s.closedWon/s.quota)}%)</span>
                <span className="badge">Discounted: {money(s.discounts)}</span>
              </div>
              <div className="row">
                <span className="tiny">ASCII speed</span>
                <button className="btn ghost" onClick={()=>setAsciiSpeed((p)=>Math.max(60,p-20))}>Faster</button>
                <button className="btn ghost" onClick={()=>setAsciiSpeed((p)=>Math.min(240,p+20))}>Slower</button>
              </div>
            </div>
          </Modal>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<Game/>);
  </script>
</body>
</html>
